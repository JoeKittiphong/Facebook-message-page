<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Messenger Clone</title>
<style>
body {
  background: black;
  font-family: system-ui, "Segoe UI", sans-serif;
  padding: 20px;
  margin: 0;
  overflow-y: auto;
}
#chatContainer {
  width : 1080px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 20px 16px 20px 0px; /* padding ‡∏ö‡∏ô ‡∏Ç‡∏ß‡∏≤ ‡∏•‡πà‡∏≤‡∏á ‡∏ã‡πâ‡∏≤‡∏¢ */
}
.bubble-row {
  display: flex;
  align-items: flex-end;
  gap: 4px;
  max-width: 90%;
  position: relative;
}
.mychat {
  align-self: flex-start;
  flex-direction: row;
}
.partner {
  align-self: flex-end;
  flex-direction: row-reverse;
}
.avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  cursor: pointer;
}
.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.avatar input {
  display: none;
}
.bubble {
  border-radius: 18px;
  padding: 8px 12px;
  font-size: 15px;
  white-space: pre-wrap;
  word-break: break-word;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.mychat .bubble {
  background: rgba(229, 229, 234, 0.55);
  color: black;
}
.partner .bubble {
  background: rgba(0, 132, 255, 0.55);
  color: white;
}
.header {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  font-weight: normal;
  opacity: 0.75;
}
.name {
  font-weight: normal;
}
.time {
  font-weight: normal;
  font-size: 12px;
  color: #aaa;
  margin-left: 8px;
  flex-shrink: 0;
}
.partner .time {
  color: rgba(255,255,255,0.6);
}
.message {
  font-size: 16px;
  font-weight: 500;
  margin-top: 2px;
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.4;
}
.image-message {
  max-width: 200px;
  border-radius: 12px;
  margin-top: 4px;
}
#buttons {
  position: fixed;
  bottom: 10px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
}
#buttons button {
  padding: 8px 14px;
  font-size: 14px;
  border: none;
  border-radius: 12px;
  background: rgba(79, 140, 255, 0.6);
  color: white;
  cursor: pointer;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.15);
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
#buttons button:hover {
  background: rgba(79, 140, 255, 0.8);
}
#speedLabel {
  color: white;
  font-size: 14px;
}
.hidden {
  display: none !important;
}
[contenteditable]:focus {
  outline: none;
}
</style>
</head>
<body>

<div id="chatContainer"></div>

<div id="buttons">
  <button id="addMyChat">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</button>
  <button id="addPartnerChat">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó‡∏Ñ‡∏π‡πà‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</button>
  <button id="addImageChat">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
  <button id="recapChat">‚ñ∂Ô∏è ‡∏£‡∏µ‡πÅ‡∏Ñ‡∏õ</button>
  <button id="saveImage">üíæ ‡πÄ‡∏ã‡∏ü‡∏†‡∏≤‡∏û</button>
  <button id="toggleButtons">üëÅÔ∏è ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°</button>
  <label id="speedLabel">
    ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß: <span id="speedValue">x1.0</span>
    <input type="range" id="speedControl" min="0.2" max="3" step="0.1">
  </label>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let myAvatarSrc = localStorage.getItem('myAvatar') || 
  "https://upload.wikimedia.org/wikipedia/commons/8/83/Facebook_Messenger_4_Logo.svg";

let savedSpeed = parseFloat(localStorage.getItem('recapSpeed')) || 1;
document.getElementById('speedControl').value = savedSpeed;
document.getElementById('speedValue').textContent = "x" + savedSpeed.toFixed(1);

function getChatData() {
  return JSON.parse(localStorage.getItem('chatData') || '[]');
}

function saveChatData(data=null) {
  if (data) {
    localStorage.setItem('chatData', JSON.stringify(data));
    return;
  }
  const rows = Array.from(document.querySelectorAll('.bubble-row'));
  const newData = rows.map(r => {
    const type = r.classList.contains('mychat') ? 'mychat' : 'partner';
    const avatar = r.querySelector('.avatar img')?.src || '';
    const name = r.querySelector('.name')?.textContent || '';
    const time = r.querySelector('.time')?.textContent || '';
    const imgEl = r.querySelector('.image-message');
    const message = imgEl ? imgEl.src : r.querySelector('.message')?.textContent || "";
    const isImage = !!imgEl;
    return { type, avatar, name, time, message, isImage };
  });
  localStorage.setItem('chatData', JSON.stringify(newData));
}

function initAvatar(labelEl) {
  const img = labelEl.querySelector('img');
  const input = labelEl.querySelector('input');
  labelEl.addEventListener('click', () => input.click());
  input.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      img.src = reader.result;
      myAvatarSrc = reader.result;
      localStorage.setItem('myAvatar', reader.result);
      saveChatData();
    };
    reader.readAsDataURL(file);
  });
}

function enableLongPressDelete(row, index) {
  let pressTimer = null;
  const start = () => {
    pressTimer = setTimeout(() => {
      if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        row.remove();
        let data = getChatData();
        data.splice(index,1);
        saveChatData(data);
      }
    }, 600);
  };
  const cancel = () => { if (pressTimer !== null) clearTimeout(pressTimer); };
  row.addEventListener('touchstart', start);
  row.addEventListener('touchend', cancel);
  row.addEventListener('touchmove', cancel);
  row.addEventListener('mousedown', start);
  row.addEventListener('mouseup', cancel);
  row.addEventListener('mouseleave', cancel);
}

function createChat(data=null, isMyChat=true, isFirst=false, index=0){
  const row = document.createElement('div');
  row.className = `bubble-row ${isMyChat?'mychat':'partner'}`;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';

  if(isMyChat && isFirst){
    const avatar = document.createElement('label');
    avatar.className = 'avatar';
    const img = document.createElement('img');
    img.src = data?.avatar || myAvatarSrc;
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    avatar.appendChild(img);
    avatar.appendChild(fileInput);
    row.appendChild(avatar);
    initAvatar(avatar);

    const header = document.createElement('div');
    header.className = 'header';
    const name = document.createElement('span');
    name.className = 'name';
    name.contentEditable = true;
    name.textContent = data?.name || "Good";
    const time = document.createElement('span');
    time.className = 'time';
    time.contentEditable = true;
    time.textContent = data?.time || "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ";
    header.appendChild(name);
    header.appendChild(time);
    bubble.appendChild(header);

    name.addEventListener('input', saveChatData);
    time.addEventListener('input', saveChatData);
  } else if(isMyChat && !isFirst){
    bubble.style.marginLeft = '32px';
  }

  if (data?.isImage) {
    const img = document.createElement('img');
    img.className = 'image-message';
    img.src = data.message;
    bubble.appendChild(img);
  } else {
    const message = document.createElement('div');
    message.className = 'message';
    message.contentEditable = true;
    message.textContent = data?.message || (isMyChat ? "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤" : "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô");
    message.addEventListener('input', saveChatData);
    bubble.appendChild(message);
  }

  row.appendChild(bubble);
  enableLongPressDelete(row, index);

  return row;
}

function addChat(isMyChat, data=null, isFirst=false){
  const container = document.getElementById('chatContainer');
  const currentData = getChatData();
  const index = currentData.length;
  const row = createChat(data, isMyChat, isFirst, index);
  container.appendChild(row);
  saveChatData();
  container.scrollTop = container.scrollHeight;
}

function addImageChat(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = e=>{
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      addChat(true,{ message: reader.result, isImage: true, avatar: myAvatarSrc, name:"Good", time:"‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ" }, false);
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

function getRecapSpeed() {
  return parseFloat(document.getElementById('speedControl').value);
}

async function recapChats() {
  saveChatData();
  const container = document.getElementById('chatContainer');
  container.innerHTML = "";
  const savedData = getChatData();
  if (!savedData.length) return;

  const speed = getRecapSpeed(); 
  const charDelay = 40 / speed;  
  const msgDelay  = 500 / speed; 

  for (let i = 0; i < savedData.length; i++) {
    const d = savedData[i];
    const row = createChat({ 
      avatar: d.avatar, 
      name: d.name, 
      time: d.time, 
      message: d.isImage ? d.message : "" ,
      isImage: d.isImage
    }, d.type === 'mychat', i===0, i);
    container.appendChild(row);

    if (d.isImage) {
      await new Promise(res => setTimeout(res, msgDelay));
    } else {
      const msgEl = row.querySelector('.message');
      const fullText = d.message;
      let typed = "";
      for (let j = 0; j < fullText.length; j++) {
        typed += fullText[j];
        msgEl.textContent = typed;
        await new Promise(res => setTimeout(res, charDelay));
      }
      await new Promise(res => setTimeout(res, msgDelay));
    }
  }
}

// initial load
const savedData = getChatData();
if(savedData.length){
  savedData.forEach((d,i)=> {
    const row = createChat(d, d.type==='mychat', i===0, i);
    document.getElementById('chatContainer').appendChild(row);
  });
}else{
  addChat(true,null,true);
  addChat(false);
}

document.getElementById('addMyChat').addEventListener('click',()=>addChat(true));
document.getElementById('addPartnerChat').addEventListener('click',()=>addChat(false));
document.getElementById('addImageChat').addEventListener('click', addImageChat);
document.getElementById('recapChat').addEventListener('click',recapChats);

document.getElementById('speedControl').addEventListener('input', e=>{
  const val = parseFloat(e.target.value);
  document.getElementById('speedValue').textContent = "x" + val.toFixed(1);
  localStorage.setItem('recapSpeed', val);
});

// ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°
document.getElementById('toggleButtons').addEventListener('click', ()=>{
  const btns = document.querySelectorAll("#buttons button:not(#toggleButtons), #speedLabel");
  btns.forEach(b=>b.classList.toggle("hidden"));
});

// ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Ñ‡∏õ
async function waitImagesLoad(container) {
  const imgs = Array.from(container.querySelectorAll('img'));
  const promises = imgs.map(img => {
    if (img.complete) return Promise.resolve();
    return new Promise(res => { img.onload = img.onerror = res; });
  });
  await Promise.all(promises);
}

// ‡πÄ‡∏ã‡∏ü‡∏†‡∏≤‡∏û‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á 1080px
document.getElementById('saveImage').addEventListener('click', async ()=>{
  const container = document.getElementById('chatContainer');
  await waitImagesLoad(container);

  const chatData = getChatData();
  let filename = "chat.png";
  if (chatData.length > 0) {
    let baseName = "";
    if (chatData[0].isImage) {
      baseName = "image-chat";
    } else {
      let text = chatData[0].message.trim();
      if (text.length > 30) text = text.substring(0, 30) + "...";
      baseName = text.replace(/[^a-zA-Z0-9‡∏Å-‡πô\s\-_]/g, "");
      if (!baseName) baseName = "chat";
    }
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,"0");
    const d = String(now.getDate()).padStart(2,"0");
    const dateStr = `${y}${m}${d}`;
    filename = dateStr + baseName + ".png";
  }

  document.getElementById('buttons').classList.add("hidden");
  const bgColor = getComputedStyle(document.body).backgroundColor;

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì scale ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á = 1080px
  const desiredWidth = 1080;
  const containerWidth = container.scrollWidth;
  const scale = desiredWidth / containerWidth;

  const canvas = await html2canvas(container, {
    backgroundColor: bgColor,
    useCORS: true,
    scale: scale,
    windowWidth: container.scrollWidth,
    windowHeight: container.scrollHeight,
    scrollY: -window.scrollY
  });
  document.getElementById('buttons').classList.remove("hidden");

  const dataURL = canvas.toDataURL("image/png");
  const link = document.createElement('a');
  link.href = dataURL;
  link.download = filename;
  link.click();
});
</script>
</body>
</html>