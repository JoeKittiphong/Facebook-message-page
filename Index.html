<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Messenger Clone</title>
<style>
body {
  margin: 0;
  font-family: system-ui, "Segoe UI", sans-serif;
  padding: 20px;
  padding-bottom: 80px;
  background: black; /* พื้นหลังดำ */
  color: white;
}

#chatContainer {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.bubble-row {
  display: flex;
  align-items: flex-end;
  gap: 4px;
  max-width: 90%;
  position: relative;
}

.mychat {
  align-self: flex-start;
  flex-direction: row;
}

.partner {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  cursor: pointer;
}
.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.avatar input {
  display: none;
}

/* bubble โปร่งใสแบบ glass */
.bubble {
  border-radius: 18px;
  padding: 8px 12px;
  font-size: 15px;
  white-space: pre-wrap;
  word-break: break-word;

  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}

.mychat .bubble {
  background: rgba(229, 229, 234, 0.55); 
  color: black;
}

.partner .bubble {
  background: rgba(0, 132, 255, 0.55); 
  color: white;
}

/* header: ชื่อ + เวลา (รอง) */
.header {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  font-weight: normal;
  opacity: 0.75;
}

.name {
  font-weight: normal;
}

.time {
  font-weight: normal;
  font-size: 12px;
  color: #aaa;
  margin-left: 8px;
  flex-shrink: 0;
}
.partner .time {
  color: rgba(255,255,255,0.6);
}

/* ข้อความ: เน้นที่สุด */
.message {
  font-size: 16px;
  font-weight: 500;
  margin-top: 2px;
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.4;
}
.partner .message {
  color: white;
}

/* ปิดกรอบเวลาโฟกัส */
[contenteditable]:focus {
  outline: none !important;
  border: none !important;
  box-shadow: none !important;
}

#buttons {
  position: fixed;
  bottom: 10px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 10px;
}

/* ปุ่ม glass */
#buttons button {
  padding: 8px 14px;
  font-size: 14px;
  border: none;
  border-radius: 12px;
  background: rgba(79, 140, 255, 0.6);
  color: white;
  cursor: pointer;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.15);
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
#buttons button:hover {
  background: rgba(79, 140, 255, 0.8);
}
</style>
</head>
<body>

<div id="chatContainer"></div>

<div id="buttons">
  <button id="addMyChat">+ เพิ่มแชทของเรา</button>
  <button id="addPartnerChat">+ เพิ่มแชทคู่สนทนา</button>
</div>

<script>
let myAvatarSrc = localStorage.getItem('myAvatar') || "https://upload.wikimedia.org/wikipedia/commons/8/83/Facebook_Messenger_4_Logo.svg";

function saveChatData() {
  const rows = Array.from(document.querySelectorAll('.bubble-row'));
  const data = rows.map((r, i) => {
    const type = r.classList.contains('mychat') ? 'mychat' : 'partner';
    const avatar = r.querySelector('.avatar img')?.src || '';
    const name = r.querySelector('.name')?.textContent || '';
    const time = r.querySelector('.time')?.textContent || '';
    const message = r.querySelector('.message').textContent;
    return { type, avatar, name, time, message };
  });
  localStorage.setItem('chatData', JSON.stringify(data));
}

function initAvatar(labelEl) {
  const img = labelEl.querySelector('img');
  const input = labelEl.querySelector('input');
  labelEl.addEventListener('click', () => input.click());
  input.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      img.src = reader.result;
      myAvatarSrc = reader.result;
      localStorage.setItem('myAvatar', reader.result);
      saveChatData();
    };
    reader.readAsDataURL(file);
  });
}

function enableLongPressDelete(row) {
  let pressTimer = null;
  const start = () => {
    pressTimer = setTimeout(() => {
      if (confirm("คุณต้องการลบแชทนี้หรือไม่?")) {
        row.remove();
        saveChatData();
        updateAvatars();
      }
    }, 600);
  };
  const cancel = () => { if (pressTimer !== null) clearTimeout(pressTimer); };
  row.addEventListener('touchstart', start);
  row.addEventListener('touchend', cancel);
  row.addEventListener('touchmove', cancel);
  row.addEventListener('mousedown', start);
  row.addEventListener('mouseup', cancel);
  row.addEventListener('mouseleave', cancel);
}

function createChat(data=null, isMyChat=true, isFirst=false){
  const row = document.createElement('div');
  row.className = `bubble-row ${isMyChat?'mychat':'partner'}`;

  const bubble = document.createElement('div');
  bubble.className = 'bubble';

  if(isMyChat && isFirst){
    const avatar = document.createElement('label');
    avatar.className = 'avatar';
    const img = document.createElement('img');
    img.src = data?.avatar || myAvatarSrc;
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    avatar.appendChild(img);
    avatar.appendChild(fileInput);
    row.appendChild(avatar);
    initAvatar(avatar);

    const header = document.createElement('div');
    header.className = 'header';
    const name = document.createElement('span');
    name.className = 'name';
    name.contentEditable = true;
    name.textContent = data?.name || "Good";
    const time = document.createElement('span');
    time.className = 'time';
    time.contentEditable = true;
    time.textContent = data?.time || "ตอนนี้";
    header.appendChild(name);
    header.appendChild(time);
    bubble.appendChild(header);

    name.addEventListener('input', saveChatData);
    time.addEventListener('input', saveChatData);
  }else if(isMyChat && !isFirst){
    bubble.style.marginLeft = '32px';
  }

  const message = document.createElement('div');
  message.className = 'message';
  message.contentEditable = true;
  message.textContent = data?.message || (isMyChat ? "ข้อความของเรา" : "ข้อความของเพื่อน");
  message.addEventListener('input', saveChatData);
  bubble.appendChild(message);

  row.appendChild(bubble);
  enableLongPressDelete(row);
  return row;
}

function addChat(isMyChat, data=null, isFirst=false){
  const container = document.getElementById('chatContainer');
  container.appendChild(createChat(data, isMyChat, isFirst));
  updateAvatars();
  saveChatData();
}

function updateAvatars(){
  const rows = Array.from(document.querySelectorAll('.bubble-row'));
  rows.forEach((r,i)=>{ r.style.marginTop = (i===0)?'20vh':'0'; });
}

const savedData = JSON.parse(localStorage.getItem('chatData')||'[]');
if(savedData.length){
  savedData.forEach((d,i)=>addChat(d.type==='mychat',d,i===0));
}else{
  addChat(true,null,true);
  addChat(false);
}

document.getElementById('addMyChat').addEventListener('click',()=>addChat(true));
document.getElementById('addPartnerChat').addEventListener('click',()=>addChat(false));
</script>

</body>
</html>