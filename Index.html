<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Messenger Clone</title>
<style>
body {
  background: black;
  font-family: system-ui, "Segoe UI", sans-serif;
  padding: 20px;
  padding-bottom: 80px; /* เผื่อพื้นที่ปุ่ม */
}
#chatContainer {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.bubble-row {
  display: flex;
  align-items: flex-end;
  gap: 4px;
  max-width: 90%;
}
.mychat {
  align-self: flex-start;
  flex-direction: row;
}
.partner {
  align-self: flex-end;
  flex-direction: row-reverse;
}
.avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  cursor: pointer;
}
.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.avatar input {
  display: none;
}
.bubble {
  border-radius: 18px;
  padding: 8px 12px;
  font-size: 15px;
  white-space: pre-wrap;
  word-break: break-word;
}
.mychat .bubble {
  background: #e5e5ea;
  color: black;
}
.partner .bubble {
  background: #0084ff;
  color: white;
}
.header {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  font-weight: bold;
}
.name[contenteditable],
.message[contenteditable],
.time[contenteditable] {
  outline: none;
}
.time {
  font-weight: normal;
  color: #555;
  margin-left: 8px;
  flex-shrink: 0;
}
.partner .time {
  color: rgba(255,255,255,0.8);
}
.message {
  font-size: 15px;
  margin-top: 2px;
  white-space: pre-wrap;
  word-break: break-word;
}
.partner .message {
  color: white;
}
#buttons {
  position: fixed;
  bottom: 10px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 10px;
}
#buttons button {
  padding: 8px 14px;
  font-size: 14px;
  border: none;
  border-radius: 8px;
  background: #4f8cff;
  color: white;
  cursor: pointer;
}
#buttons button:hover {
  background: #3a6edc;
}
</style>
</head>
<body>

<div id="chatContainer">
  <!-- แชทจะถูกสร้างด้วย JavaScript -->
</div>

<div id="buttons">
  <button id="addMyChat">+ เพิ่มแชทของเรา</button>
  <button id="addPartnerChat">+ เพิ่มแชทคู่สนทนา</button>
</div>

<script>
let myAvatarSrc = localStorage.getItem('myAvatar') || "https://upload.wikimedia.org/wikipedia/commons/8/83/Facebook_Messenger_4_Logo.svg";
let partnerAvatarSrc = localStorage.getItem('partnerAvatar') || "https://upload.wikimedia.org/wikipedia/commons/8/83/Facebook_Messenger_4_Logo.svg";

function saveChatData() {
  const rows = Array.from(document.querySelectorAll('.bubble-row'));
  const data = rows.map(r => {
    const type = r.classList.contains('mychat') ? 'mychat' : 'partner';
    const avatar = r.querySelector('.avatar img').src;
    const name = r.querySelector('.name').textContent;
    const time = r.querySelector('.time').textContent;
    const message = r.querySelector('.message').textContent;
    return { type, avatar, name, time, message };
  });
  localStorage.setItem('chatData', JSON.stringify(data));
}

function initAvatar(labelEl, isMyChat) {
  const img = labelEl.querySelector('img');
  const input = labelEl.querySelector('input');
  labelEl.addEventListener('click', () => input.click());
  input.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      img.src = reader.result;
      if (isMyChat) {
        myAvatarSrc = reader.result;
        localStorage.setItem('myAvatar', reader.result);
      } else {
        partnerAvatarSrc = reader.result;
        localStorage.setItem('partnerAvatar', reader.result);
      }
      saveChatData();
    };
    reader.readAsDataURL(file);
  });
}

function createChat(data = null, isMyChat = true) {
  const row = document.createElement('div');
  row.className = `bubble-row ${isMyChat ? 'mychat' : 'partner'}`;
  
  const avatar = document.createElement('label');
  avatar.className = 'avatar';
  const img = document.createElement('img');
  img.src = data?.avatar || (isMyChat ? myAvatarSrc : partnerAvatarSrc);
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  avatar.appendChild(img);
  avatar.appendChild(fileInput);
  
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  
  const header = document.createElement('div');
  header.className = 'header';
  const name = document.createElement('span');
  name.className = 'name';
  name.contentEditable = "true";
  name.textContent = data?.name || (isMyChat ? "Good" : "Friend");
  const time = document.createElement('span');
  time.className = 'time';
  time.contentEditable = "true";
  time.textContent = data?.time || "ตอนนี้";
  header.appendChild(name);
  header.appendChild(time);
  
  const message = document.createElement('div');
  message.className = 'message';
  message.contentEditable = "true";
  message.textContent = data?.message || (isMyChat ? "ข้อความของเรา" : "ข้อความของเพื่อน");
  
  bubble.appendChild(header);
  bubble.appendChild(message);
  
  if (isMyChat) {
    row.appendChild(avatar);
    row.appendChild(bubble);
  } else {
    row.appendChild(avatar);
    row.appendChild(bubble);
    row.style.flexDirection = "row-reverse";
  }
  
  initAvatar(avatar, isMyChat);

  // บันทึกเมื่อแก้ไขชื่อ เวลา หรือข้อความ
  name.addEventListener('input', saveChatData);
  time.addEventListener('input', saveChatData);
  message.addEventListener('input', saveChatData);

  return row;
}

function addChat(isMyChat, data = null) {
  const container = document.getElementById('chatContainer');
  container.appendChild(createChat(data, isMyChat));
  updateAvatars();
  saveChatData();
}

function updateAvatars() {
  const rows = Array.from(document.querySelectorAll('.bubble-row'));
  rows.forEach((r, i) => {
    r.querySelector('.avatar').style.visibility = 'hidden';
    r.style.marginTop = '0';
    if (i === 0) r.style.marginTop = '40vh'; // แถวแรกลงมาห่าง 20%
  });

  let lastType = '';
  for (let i = rows.length - 1; i >= 0; i--) {
    const type = rows[i].classList.contains('mychat') ? 'mychat' : 'partner';
    if (type !== lastType) {
      rows[i].querySelector('.avatar').style.visibility = 'visible';
      lastType = type;
    }
  }
}

// โหลด chat จาก localStorage
const savedData = JSON.parse(localStorage.getItem('chatData') || '[]');
if (savedData.length) {
  savedData.forEach(d => addChat(d.type === 'mychat', d));
} else {
  addChat(true);  // แชทของเราเริ่มต้น
  addChat(false); // แชทคู่สนทนาเริ่มต้น
}

document.getElementById('addMyChat').addEventListener('click', () => addChat(true));
document.getElementById('addPartnerChat').addEventListener('click', () => addChat(false));
</script>

</body>
</html>